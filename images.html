<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POKECOLE - Gestion des Images Manquantes</title>
    <style>
        *{box-sizing:border-box;font-family:'Segoe UI',sans-serif}
        body{margin:0;padding:20px;background:linear-gradient(135deg,#1a1a2e,#16213e);min-height:100vh;color:#fff}
        .container{max-width:1400px;margin:0 auto}
        h1{text-align:center;color:#ffd700;margin-bottom:10px}
        h2{color:#ffd700;margin-top:30px}
        .subtitle{text-align:center;color:#aaa;margin-bottom:30px}
        .nav{display:flex;gap:15px;margin-bottom:20px;justify-content:center}
        .nav a{color:#fff;text-decoration:none;padding:10px 20px;background:rgba(255,255,255,0.1);border-radius:8px}
        .nav a:hover{background:rgba(255,255,255,0.2)}
        .nav a.active{background:#4CAF50}
        .config-section{background:rgba(255,255,255,0.1);border-radius:15px;padding:20px;margin-bottom:20px}
        .config-section h3{margin-top:0;color:#ffd700}
        .github-config{display:grid;grid-template-columns:1fr 1fr;gap:15px}
        .github-config input{width:100%;padding:10px;border-radius:8px;border:none}
        button{padding:10px 20px;border-radius:8px;border:none;cursor:pointer;font-size:14px;transition:all 0.2s}
        button:hover{transform:translateY(-2px)}
        .btn-primary{background:#4CAF50;color:#fff}
        .btn-secondary{background:#2196F3;color:#fff}
        .btn-danger{background:#f44336;color:#fff}
        .btn-warning{background:#ff9800;color:#fff}
        .status-message{padding:15px;border-radius:8px;margin-bottom:20px;display:none}
        .status-message.success{display:block;background:rgba(76,175,80,0.3);border:1px solid #4CAF50}
        .status-message.error{display:block;background:rgba(244,67,54,0.3);border:1px solid #f44336}
        .status-message.info{display:block;background:rgba(33,150,243,0.3);border:1px solid #2196F3}
        .cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;margin-top:20px}
        .card-item{background:rgba(255,255,255,0.95);color:#333;border-radius:10px;padding:15px;position:relative}
        .card-item.has-image{border:3px solid #4CAF50}
        .card-item h4{margin:0 0 5px 0;font-size:14px}
        .card-item .card-id{font-size:12px;color:#666;margin-bottom:10px}
        .card-item .card-set{font-size:11px;color:#888;margin-bottom:10px}
        .card-item .card-date{font-size:10px;color:#aaa}
        .card-item .preview{width:100%;height:150px;background:#f0f0f0;border-radius:8px;margin:10px 0;display:flex;align-items:center;justify-content:center;overflow:hidden}
        .card-item .preview img{max-width:100%;max-height:100%;object-fit:contain}
        .card-item .preview.empty{border:2px dashed #ccc}
        .card-item .actions{display:flex;gap:10px;margin-top:10px}
        .card-item .actions button{flex:1;padding:8px;font-size:12px}
        .upload-input{display:none}
        .stats-bar{display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap}
        .stat-box{background:rgba(255,255,255,0.1);padding:15px 25px;border-radius:10px;text-align:center}
        .stat-box .number{font-size:28px;font-weight:bold;color:#ffd700}
        .stat-box .label{font-size:12px;color:#aaa}
        .loading{text-align:center;padding:40px;color:#aaa}
        .empty-state{text-align:center;padding:40px;color:#888;background:rgba(255,255,255,0.05);border-radius:15px}
        @media(max-width:768px){.github-config{grid-template-columns:1fr}.cards-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div class="container">
    <h1>üé¥ POKECOLE - Gestion des Images</h1>
    <p class="subtitle">G√©rer les images de cartes manquantes</p>

    <nav class="nav">
        <a href="index.html">üìù Questions</a>
        <a href="images.html" class="active">üñºÔ∏è Images</a>
    </nav>

    <div id="statusMessage" class="status-message"></div>

    <div class="config-section">
        <h3>‚öôÔ∏è Configuration GitHub</h3>
        <div class="github-config">
            <div><label>Repository (user/repo)</label><input type="text" id="githubRepo" placeholder="username/pokecole-questions"></div>
            <div><label>Token GitHub</label><input type="password" id="githubToken" placeholder="ghp_xxx"></div>
        </div>
        <div style="margin-top:15px;display:flex;gap:10px;flex-wrap:wrap">
            <button onclick="saveConfig()" class="btn-primary">üíæ Sauvegarder</button>
            <button onclick="testConnection()" class="btn-secondary">üîó Tester</button>
            <button onclick="loadMissingImages()" class="btn-secondary">üì• Charger images manquantes</button>
        </div>
    </div>

    <div class="stats-bar" id="statsBar">
        <div class="stat-box"><div class="number" id="statMissing">-</div><div class="label">Manquantes</div></div>
        <div class="stat-box"><div class="number" id="statUploaded">-</div><div class="label">Upload√©es</div></div>
        <div class="stat-box"><div class="number" id="statPending">-</div><div class="label">En attente</div></div>
    </div>

    <h2>üñºÔ∏è Images Manquantes</h2>
    <div class="cards-grid" id="cardsGrid">
        <div class="loading">Chargez la configuration GitHub puis cliquez sur "Charger images manquantes"</div>
    </div>
</div>

<script>
let githubConfig = {repo:'', token:''};
let missingImages = {};
let manualImages = {};

document.addEventListener('DOMContentLoaded', () => {
    loadConfig();
});

function loadConfig() {
    const saved = localStorage.getItem('pokecole_github_config');
    if (saved) {
        githubConfig = JSON.parse(saved);
        document.getElementById('githubRepo').value = githubConfig.repo || '';
        document.getElementById('githubToken').value = githubConfig.token || '';
    }
}

function saveConfig() {
    githubConfig.repo = document.getElementById('githubRepo').value.trim();
    githubConfig.token = document.getElementById('githubToken').value.trim();
    localStorage.setItem('pokecole_github_config', JSON.stringify(githubConfig));
    showStatus('Configuration sauvegard√©e!', 'success');
}

async function testConnection() {
    if (!githubConfig.repo || !githubConfig.token) {
        showStatus('Configurez repo et token', 'error');
        return;
    }
    try {
        const r = await fetch(`https://api.github.com/repos/${githubConfig.repo}`, {
            headers: {'Authorization': `token ${githubConfig.token}`}
        });
        showStatus(r.ok ? '‚úÖ Connexion OK' : '‚ùå Erreur ' + r.status, r.ok ? 'success' : 'error');
    } catch(e) {
        showStatus('‚ùå ' + e.message, 'error');
    }
}

async function loadMissingImages() {
    if (!githubConfig.repo || !githubConfig.token) {
        showStatus('Configurez GitHub d\'abord', 'error');
        return;
    }

    showStatus('Chargement...', 'info');
    document.getElementById('cardsGrid').innerHTML = '<div class="loading">Chargement en cours...</div>';

    try {
        // Charger les images manquantes
        const missingRes = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/images/missing_images.json`, {
            headers: {'Authorization': `token ${githubConfig.token}`}
        });

        if (missingRes.ok) {
            const data = await missingRes.json();
            const content = JSON.parse(atob(data.content));
            missingImages = content.images || {};
        } else if (missingRes.status !== 404) {
            throw new Error('Erreur ' + missingRes.status);
        }

        // Charger les images manuelles existantes
        const manualRes = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/images/manual_images.json`, {
            headers: {'Authorization': `token ${githubConfig.token}`}
        });

        if (manualRes.ok) {
            const data = await manualRes.json();
            const content = JSON.parse(atob(data.content));
            manualImages = content.images || {};
        }

        updateStats();
        renderCards();
        showStatus(`‚úÖ ${Object.keys(missingImages).length} image(s) manquante(s) charg√©e(s)`, 'success');
    } catch(e) {
        showStatus('‚ùå ' + e.message, 'error');
        document.getElementById('cardsGrid').innerHTML = '<div class="empty-state">Erreur de chargement</div>';
    }
}

function updateStats() {
    const missing = Object.keys(missingImages).length;
    const uploaded = Object.keys(manualImages).length;
    const pending = missing - Object.keys(missingImages).filter(id => manualImages[id]).length;

    document.getElementById('statMissing').textContent = missing;
    document.getElementById('statUploaded').textContent = uploaded;
    document.getElementById('statPending').textContent = pending;
}

function renderCards() {
    const grid = document.getElementById('cardsGrid');
    const cards = Object.entries(missingImages);

    if (cards.length === 0) {
        grid.innerHTML = '<div class="empty-state">üéâ Aucune image manquante!</div>';
        return;
    }

    grid.innerHTML = cards.map(([id, info]) => {
        const hasImage = manualImages[id];
        return `
            <div class="card-item ${hasImage ? 'has-image' : ''}">
                <h4>${info.name || id}</h4>
                <div class="card-id">ID: ${id}</div>
                ${info.set ? `<div class="card-set">Set: ${info.set}</div>` : ''}
                <div class="card-date">Signal√©: ${info.reported_at || 'N/A'}</div>
                <div class="preview ${hasImage ? '' : 'empty'}">
                    ${hasImage ? `<img src="${manualImages[id]}" alt="${id}">` : 'üì∑ Pas d\'image'}
                </div>
                <div class="actions">
                    <input type="file" id="file_${id.replace(/[^a-zA-Z0-9]/g,'_')}" class="upload-input" accept="image/*" onchange="uploadImage('${id}', this)">
                    <button onclick="document.getElementById('file_${id.replace(/[^a-zA-Z0-9]/g,'_')}').click()" class="btn-warning">üì§ Upload</button>
                    ${hasImage ? `<button onclick="removeImage('${id}')" class="btn-danger">üóëÔ∏è</button>` : ''}
                </div>
            </div>
        `;
    }).join('');
}

async function uploadImage(cardId, input) {
    if (!input.files || !input.files[0]) return;

    const file = input.files[0];
    showStatus(`Traitement de ${file.name}...`, 'info');

    try {
        // Lire et potentiellement compresser l'image
        const imageData = await processImage(file);

        // Upload sur GitHub
        const fileName = `images/manual/${cardId.replace(/[^a-zA-Z0-9-]/g, '_')}.png`;

        // V√©rifier si le fichier existe d√©j√†
        let sha = null;
        try {
            const checkRes = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/${fileName}`, {
                headers: {'Authorization': `token ${githubConfig.token}`}
            });
            if (checkRes.ok) {
                const existing = await checkRes.json();
                sha = existing.sha;
            }
        } catch(e) {}

        const body = {
            message: `Add manual image for ${cardId}`,
            content: imageData.base64,
            branch: 'main'
        };
        if (sha) body.sha = sha;

        const uploadRes = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/${fileName}`, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${githubConfig.token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
        });

        if (!uploadRes.ok) throw new Error('Erreur upload: ' + uploadRes.status);

        const uploadData = await uploadRes.json();
        const imageUrl = uploadData.content.download_url;

        // Mettre √† jour manual_images.json
        manualImages[cardId] = imageUrl;
        await saveManualImagesJson();

        updateStats();
        renderCards();
        showStatus(`‚úÖ Image upload√©e pour ${cardId}`, 'success');
    } catch(e) {
        showStatus('‚ùå ' + e.message, 'error');
    }

    input.value = '';
}

async function processImage(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
            const img = new Image();
            img.onload = () => {
                // Cr√©er un canvas pour traiter l'image
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // Redimensionner si trop grande (max 800px de large)
                const maxWidth = 800;
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                // Dessiner l'image (conserve la transparence)
                ctx.drawImage(img, 0, 0, width, height);

                // Compresser si n√©cessaire (cible < 300Ko)
                let quality = 0.9;
                let base64 = canvas.toDataURL('image/png');

                // Si PNG trop lourd, essayer avec compression progressive
                while (base64.length > 400000 && quality > 0.3) { // ~300Ko en base64
                    quality -= 0.1;
                    // Pour garder la transparence, on reste en PNG mais on r√©duit la taille
                    const newWidth = Math.floor(width * 0.9);
                    const newHeight = Math.floor(height * 0.9);
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    base64 = canvas.toDataURL('image/png');
                    width = newWidth;
                    height = newHeight;
                }

                // Retirer le pr√©fixe data:image/png;base64,
                const pureBase64 = base64.split(',')[1];

                console.log(`Image trait√©e: ${width}x${height}, taille: ${Math.round(pureBase64.length * 0.75 / 1024)}Ko`);

                resolve({base64: pureBase64, width, height});
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

async function saveManualImagesJson() {
    const content = JSON.stringify({images: manualImages, updated_at: new Date().toISOString()}, null, 2);
    const base64 = btoa(unescape(encodeURIComponent(content)));

    // V√©rifier SHA existant
    let sha = null;
    try {
        const checkRes = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/images/manual_images.json`, {
            headers: {'Authorization': `token ${githubConfig.token}`}
        });
        if (checkRes.ok) {
            const existing = await checkRes.json();
            sha = existing.sha;
        }
    } catch(e) {}

    const body = {
        message: 'Update manual_images.json',
        content: base64,
        branch: 'main'
    };
    if (sha) body.sha = sha;

    await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/images/manual_images.json`, {
        method: 'PUT',
        headers: {
            'Authorization': `token ${githubConfig.token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
    });
}

async function removeImage(cardId) {
    if (!confirm(`Supprimer l'image pour ${cardId} ?`)) return;

    try {
        showStatus('Suppression...', 'info');

        // Supprimer le fichier image
        const fileName = `images/manual/${cardId.replace(/[^a-zA-Z0-9-]/g, '_')}.png`;
        const checkRes = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/${fileName}`, {
            headers: {'Authorization': `token ${githubConfig.token}`}
        });

        if (checkRes.ok) {
            const existing = await checkRes.json();
            await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/${fileName}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${githubConfig.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Remove manual image for ${cardId}`,
                    sha: existing.sha,
                    branch: 'main'
                })
            });
        }

        // Mettre √† jour manual_images.json
        delete manualImages[cardId];
        await saveManualImagesJson();

        updateStats();
        renderCards();
        showStatus(`‚úÖ Image supprim√©e pour ${cardId}`, 'success');
    } catch(e) {
        showStatus('‚ùå ' + e.message, 'error');
    }
}

function showStatus(msg, type) {
    const el = document.getElementById('statusMessage');
    el.textContent = msg;
    el.className = 'status-message ' + type;
    if (type !== 'error') setTimeout(() => el.className = 'status-message', 4000);
}
</script>
</body>
</html>
